function [fx, dfx]=EperBS(coefs,splines, parEper)

% TODO
% Comment, docs

global opt sceneInfo T;
% How many splines?
N=length(splines);

% state vector length
C=length(coefs);

% initialize value and derivative with 0
fx=0;
dfx=zeros(C,1);

offsetjump=1;

splos=0; % splines segments offset

nf=parEper(1); % normalize to from mm to meter
k=parEper(2); % parameter for enter buffer
ksqnfsq=k^2*nf^2;

imOnGP=sceneInfo.imOnGP;
x1=imOnGP(1);y1=imOnGP(2);
x2=imOnGP(3);y2=imOnGP(4);
x3=imOnGP(5);y3=imOnGP(6);
x4=imOnGP(7);y4=imOnGP(8);

for id=1:N
    spl=splines(id);
    
    % how many segments?
    tr=spl.start:spl.end;
    index = spl.index;
    knots = spl.knots;
    sn=spl.number;

        derl=zeros(8,1);dert=zeros(8,1);derr=zeros(8,1);derb=zeros(8,1);

    if spl.start>1.5
        
        lcnt=1;
        ilcnt=index(lcnt);
        bslcnt=ilcnt+3;
        curt=tr(lcnt);
%         curt
        tx=knots(bslcnt-2:bslcnt+3);%-tr(lcnt);
        
        os=splos;
        svpos=[os+ilcnt:os+ilcnt+3 os+ilcnt+sn:os+ilcnt+3+sn];
        clocx=coefs(svpos(1:4))';
        clocy=coefs(svpos(5:8))';
        
        t1=tx(1);t2=tx(2);t3=tx(3);t4=tx(4); t5=tx(5);t6=tx(6);
        c1x=clocx(1);c2x=clocx(2);c3x=clocx(3);c4x=clocx(4);
        c1y=clocy(1);c2y=clocy(2);c3y=clocy(3);c4y=clocy(4);
        
        cmt1=curt-t1;cmt2=curt-t2;cmt3=curt-t3;cmt4=curt-t4;cmt5=curt-t5;cmt6=curt-t6;
        t14=t1-t4;        t24=t2-t4;        t25=t2-t5;        t35=t3-t5;        t36=t3-t6;
        c2x_cmt1_c1x_cmt4=(c2x*cmt1 - c1x*cmt4);
        c2y_cmt1_c1y_cmt4=(c2y*cmt1 - c1y*cmt4);

        px=-(((((c2x*(curt - t1) - c1x*(curt - t4))*(curt - t4))/(t1 - t4) - ((c3x*(curt - t2) - c2x*(curt - t5))*(curt - t2))/(t2 - t5))*(curt - t4))/(t2 - t4) - ((((c3x*(curt - t2) - c2x*(curt - t5))*(curt - t5))/(t2 - t5) - ((c4x*(curt - t3) - c3x*(curt - t6))*(curt - t3))/(t3 - t6))*(curt - t3))/(t3 - t5))/(t3 - t4);
        py=-(((((c2y*(curt - t1) - c1y*(curt - t4))*(curt - t4))/(t1 - t4) - ((c3y*(curt - t2) - c2y*(curt - t5))*(curt - t2))/(t2 - t5))*(curt - t4))/(t2 - t4) - ((((c3y*(curt - t2) - c2y*(curt - t5))*(curt - t5))/(t2 - t5) - ((c4y*(curt - t3) - c3y*(curt - t6))*(curt - t3))/(t3 - t6))*(curt - t3))/(t3 - t5))/(t3 - t4);

        % left
        x0=imOnGP(1);y0=imOnGP(2); x1=imOnGP(3);y1=imOnGP(4);
        dl = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); dl=dl/nf;
        ol = (k^2/6)*(1-(1-(dl/k)^2)^3);


        derl(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derl(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        derl(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derl(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);


        if abs(dl)>=k, derl(:)=0; ol=k^2/6; end
        ol=ol*6/k;

        % top
        x0=imOnGP(3);y0=imOnGP(4); x1=imOnGP(5);y1=imOnGP(6);
        dt = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); dt=dt/nf;
        ot = (k^2/6)*(1-(1-(dt/k)^2)^3);
        dert(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        dert(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        dert(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        dert(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        if abs(dt)>=k, dert(:)=0; ot=k^2/6; end
        ot=ot*6/k;
        
        % right
        x0=imOnGP(5);y0=imOnGP(6); x1=imOnGP(7);y1=imOnGP(8);
        dr = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); dr=dr/nf;
        or = (k^2/6)*(1-(1-(dr/k)^2)^3);
        derr(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derr(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        derr(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derr(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        if abs(dr)>=k, derr(:)=0; or=k^2/6; end
        or=or*6/k;
        
        % bottom
        x0=imOnGP(7);y0=imOnGP(8); x1=imOnGP(1);y1=imOnGP(2);
        db = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); db=db/nf;
        ob = (k^2/6)*(1-(1-(db/k)^2)^3);
        derb(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derb(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        derb(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derb(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        if abs(db)>=k, derb(:)=0; ob=k^2/6; end
        ob=ob*6/k;
        
        
        obj=ol*ot*or*ob;
%         obj=ol*ot;
        
        allder=derl*ot*or*ob + ol*dert*or*ob + ol*ot*derr*ob + ol*ot*or*derb;
%         dery=deryl*ot*or*ob + ol*deryt*or*ob + ol*ot*deryr*ob + ol*ot*or*deryb;
%         derx=derl;
%         allder=derl*ot + ol*dert;


        fx=fx+obj;
        
%         dfx(os+1:os+8) = allder;
        dfx(svpos(1:4)) = dfx(svpos(1:4))+allder(1:4);
        dfx(svpos(5:8)) = dfx(svpos(5:8))+allder(5:8);
        
        
        
    end
    

    derl=zeros(8,1);dert=zeros(8,1);derr=zeros(8,1);derb=zeros(8,1);
    % persistence end
    
    if spl.end<T-.5
        
        lcnt=length(tr);
        ilcnt=index(lcnt);
        bslcnt=ilcnt+3;
        curt=tr(lcnt);
        tx=knots(bslcnt-2:bslcnt+3);%-tr(lcnt);
        
        os=splos;
        svpos=[os+ilcnt:os+ilcnt+3 os+ilcnt+sn:os+ilcnt+3+sn];
        clocx=coefs(svpos(1:4))';
        clocy=coefs(svpos(5:8))';
        
        t1=tx(1);t2=tx(2);t3=tx(3);t4=tx(4); t5=tx(5);t6=tx(6);
        c1x=clocx(1);c2x=clocx(2);c3x=clocx(3);c4x=clocx(4);
        c1y=clocy(1);c2y=clocy(2);c3y=clocy(3);c4y=clocy(4);
        
        cmt1=curt-t1;cmt2=curt-t2;cmt3=curt-t3;cmt4=curt-t4;cmt5=curt-t5;cmt6=curt-t6;
        t14=t1-t4;        t24=t2-t4;        t25=t2-t5;        t35=t3-t5;        t36=t3-t6;
        c2x_cmt1_c1x_cmt4=(c2x*cmt1 - c1x*cmt4);
        c2y_cmt1_c1y_cmt4=(c2y*cmt1 - c1y*cmt4);

        px=-(((((c2x*(curt - t1) - c1x*(curt - t4))*(curt - t4))/(t1 - t4) - ((c3x*(curt - t2) - c2x*(curt - t5))*(curt - t2))/(t2 - t5))*(curt - t4))/(t2 - t4) - ((((c3x*(curt - t2) - c2x*(curt - t5))*(curt - t5))/(t2 - t5) - ((c4x*(curt - t3) - c3x*(curt - t6))*(curt - t3))/(t3 - t6))*(curt - t3))/(t3 - t5))/(t3 - t4);
        py=-(((((c2y*(curt - t1) - c1y*(curt - t4))*(curt - t4))/(t1 - t4) - ((c3y*(curt - t2) - c2y*(curt - t5))*(curt - t2))/(t2 - t5))*(curt - t4))/(t2 - t4) - ((((c3y*(curt - t2) - c2y*(curt - t5))*(curt - t5))/(t2 - t5) - ((c4y*(curt - t3) - c3y*(curt - t6))*(curt - t3))/(t3 - t6))*(curt - t3))/(t3 - t5))/(t3 - t4);

        % left
        x0=imOnGP(1);y0=imOnGP(2); x1=imOnGP(3);y1=imOnGP(4);
        dl = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); dl=dl/nf;
        ol = (k^2/6)*(1-(1-(dl/k)^2)^3);


        derl(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derl(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        derl(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derl(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derl(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);


        if abs(dl)>=k, derl(:)=0; ol=k^2/6; end
        ol=ol*6/k;

        % top
        x0=imOnGP(3);y0=imOnGP(4); x1=imOnGP(5);y1=imOnGP(6);
        dt = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); dt=dt/nf;
        ot = (k^2/6)*(1-(1-(dt/k)^2)^3);
        dert(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        dert(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        dert(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        dert(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        dert(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        if abs(dt)>=k, dert(:)=0; ot=k^2/6; end
        ot=ot*6/k;
        
        % right
        x0=imOnGP(5);y0=imOnGP(6); x1=imOnGP(7);y1=imOnGP(8);
        dr = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); dr=dr/nf;
        or = (k^2/6)*(1-(1-(dr/k)^2)^3);
        derr(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derr(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        derr(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derr(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derr(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        if abs(dr)>=k, derr(:)=0; or=k^2/6; end
        or=or*6/k;
        
        % bottom
        x0=imOnGP(7);y0=imOnGP(8); x1=imOnGP(1);y1=imOnGP(2);
        db = ((y0-y1)*px + (x1-x0)*py + (x0*y1-x1*y0) ) / (sqrt((x1-x0)^2 + (y1-y0)^2) ); db=db/nf;
        ob = (k^2/6)*(1-(1-(db/k)^2)^3);
        derb(1) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derb(2) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(3) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(y0 - y1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(4) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(y0 - y1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        derb(5) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt4^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*t14*t24*(t3 - t4));
        derb(6) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt1*cmt4)/t14 + (cmt2*cmt5)/t25)*cmt4)/t24 + (cmt3*cmt5^2)/(t25*t35))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(7) = -(6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*(x0 - x1)*((((cmt2*cmt5)/t25 + (cmt3*cmt6)/t36)*cmt3)/t35 + (cmt2^2*cmt4)/(t24*t25))*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4));
        derb(8) = (6*((x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4))^2/(k^2*nf^2*((x0 - x1)^2 + (y0 - y1)^2)) - 1)^2*cmt3^3*(x0 - x1)*(x0*y1 - x1*y0 + (((((c2y_cmt1_c1y_cmt4*cmt4)/t14 - ((c3y*cmt2 - c2y*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3y*cmt2 - c2y*cmt5)*cmt5)/t25 - ((c4y*cmt3 - c3y*cmt6)*cmt3)/t36)*cmt3)/t35)*(x0 - x1))/(t3 - t4) - (((((c2x_cmt1_c1x_cmt4*cmt4)/t14 - ((c3x*cmt2 - c2x*cmt5)*cmt2)/t25)*cmt4)/t24 - ((((c3x*cmt2 - c2x*cmt5)*cmt5)/t25 - ((c4x*cmt3 - c3x*cmt6)*cmt3)/t36)*cmt3)/t35)*(y0 - y1))/(t3 - t4)))/(k*nf^2*((x0 - x1)^2 + (y0 - y1)^2)*(t3 - t4)*t35*t36);
        if abs(db)>=k, derb(:)=0; ob=k^2/6; end
        ob=ob*6/k;
        
        
        obj=ol*ot*or*ob;
%         obj=ol*ot;
        
        allder=derl*ot*or*ob + ol*dert*or*ob + ol*ot*derr*ob + ol*ot*or*derb;
%         dery=deryl*ot*or*ob + ol*deryt*or*ob + ol*ot*deryr*ob + ol*ot*or*deryb;
%         derx=derl;
%         allder=derl*ot + ol*dert;


        fx=fx+obj;
        
%         dfx(os+1:os+8) = allder;
        dfx(svpos(1:4)) = dfx(svpos(1:4))+allder(1:4);
        dfx(svpos(5:8)) = dfx(svpos(5:8))+allder(5:8);
        
        
        
    end
    
    splos = splos + sn*2;
end

end